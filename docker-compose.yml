version: '3'

services:
    api-dummy-fpm:
        build:
            context: ./api-dummy
        volumes:
            - ./api-dummy:/srv/app
            - /srv/app/public/bundles
            - /srv/app/var
            - /srv/app/vendor
        environment:
            - APP_ENV=dev
            - APP_SECRET=f6a87c2e031ecadc0d7eb442729435c5
    api-dummy-nginx:
        image: nginx:1.13
        ports:
            - '8081:80'
        volumes:
            - ./api-dummy/.docker/nginx-server.conf:/etc/nginx/conf.d/default.conf
            - ./api-dummy/public:/srv/app/public
        depends_on:
            - api-dummy-fpm
    article-store:
        build:
            context: ./article_store
        command: >
                /bin/bash -c "
                    until echo > /dev/tcp/postgres/5432; do sleep 1; done
                    pipenv run python manage.py migrate articles
                    pipenv run python manage.py migrate
                    pipenv run python manage.py runserver 0.0.0.0:8000
                "
        ports:
          - '8000:8000'
        depends_on:
          - postgres
    postgres:
        image: postgres:9.6.8-alpine
        environment:
          - POSTGRES_USER=root
          - POSTGRES_PASSWORD=rootpassword
          - POSTGRES_DB=default
        ports:
          - '5432:5432'
        volumes:
          - 'postgres:/var/lib/postgresql/data'
    journal-fpm:
        build:
            context: ./journal
        volumes:
            - ./journal:/srv/app
            - /srv/app/public/bundles
            - /srv/app/var
            - /srv/app/vendor
        environment:
            - APP_ENV=dev
            - APP_LIBERO_API=http://article-store:8000
            - APP_SECRET=f6a87c2e031ecadc0d7eb442729435c6
        depends_on:
            - api-dummy-nginx
    journal-nginx:
        image: nginx:1.13
        ports:
            - '8080:80'
        volumes:
            - ./journal/.docker/nginx-server.conf:/etc/nginx/conf.d/default.conf
            - ./journal/public:/srv/app/public
        depends_on:
            - journal-fpm
volumes:
  postgres: